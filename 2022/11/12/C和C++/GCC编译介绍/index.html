

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/ap0l1o.png">
  <link rel="icon" href="/img/ap0l1o.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="C/C++头文件、静态库和动态库小结。">
  <meta name="author" content="ap0l1o">
  <meta name="keywords" content="">
  
  <title>C/C++头文件和库 - ap0l1o</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Ap0l1o</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                主页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-books"></i>
                大概
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/%E6%8A%80%E6%9C%AF/">
                    
                    技术
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/%E7%94%9F%E6%B4%BB/">
                    
                    生活
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/%E4%B9%A6%E5%BD%B1%E9%9F%B3/">
                    
                    书影音
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/%E8%AE%BA%E6%96%87/">
                    
                    论文
                  </a>
                
              </div>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/running/">
                
                跑步
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/hello.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="C/C++头文件和库">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-11-12 21:40" pubdate>
        2022年11月12日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      4k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      44
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">C/C++头文件和库</h1>
            
            <div class="markdown-body">
              <h2 id="GCC介绍🎯"><a href="#GCC介绍🎯" class="headerlink" title="GCC介绍🎯"></a>GCC介绍🎯</h2><p>GCC最初是「GNU C Compiler」的简称，从名字也可以看出，其原本只是当作一个C语言的编译器。而经过十几年的发展，GCC已经不仅仅能编译C程序，而且支持C++、Java程序的编译，GCC也不再是「GNU C Complier」的意思，而表示「GNU Compiler Collection」，也即是GNU编译器集合的意思。<br>GCC是一组编译工具的总称，其软件包中包含众多的工具，按其类型，主要有以下分类：</p>
<ul>
<li>源代码预处理程序：<code>cpp</code>和<code>cpp0</code></li>
<li>C编译器：<code>cc</code>、<code>cc1</code>、<code>cc1plus</code>、<code>gcc</code></li>
<li>C++ 编译器：<code>c++</code>、<code>cc1plus</code>、<code>g++</code></li>
<li>库文件：<code>libgcc.a</code>、<code>libgcc_eh.a</code>、<code>lib_gcc_s.so</code>、<code>libiberty.a</code>、<code>libstdc++.a</code>、libstdc++.so、<code>libsup++.a</code><br>而gcc和g++实际上是一个编译器驱动程序，它虽然不知道如何解析或编译源代码，但它知道如何调用实际的编译器、汇编器和链接器来处理源代码。<blockquote>
<p>关于gcc和g++：<br>g++不仅会吧<code>.cpp</code>文件当作C++程序文件调用<code>cc1plus</code>进行编译，而且还会把<code>.c</code>文件当作C++语言文件（在<code>.c</code>文件前后分别加上-<code>xc++</code>和<code>-xnone</code>，强行变成C++），并调用<code>cc1plus</code>进行编译，此外在链接过程中还会默认链接上C++标准库。<br>gcc会把.c文件当作是C语言文件从而调用cc1进行编译，而遇到.cpp文件时会处理成C++语言，并调用cc1plus进行编译。不过gcc默认不会链接到C++标准库，因此需要手动加上<code>-lstdc++</code>链接选项。</p>
</blockquote>
</li>
</ul>
<p>在使用<code>gcc/g++</code>编译程序时，编译过程可以被细分为以下四个阶段：</p>
<ul>
<li>预处理（Pre-Processing）：首先调用<code>cpp</code>命令进行预处理，主要实现对源代码编译前的预处理，比如将源代码中指定的头文件包含进来，预处理后的C和C++程序文件分别是<code>.i</code>和<code>.ii</code>文件（预处理后的文件仍是C/C++代码）。</li>
<li>编译（Compiling）：调用<code>cc1/cc1plus</code>命令进行编译，作为整个编译过程中的一个中间步骤，该过程会将源代码翻译生成汇编代码，也即<code>.s</code>文件。</li>
<li>汇编（Assembling）：汇编过程是针对汇编代码的步骤，调用<code>as</code>命令进行工作，生成扩展名为<code>.o</code>的目标文件。</li>
<li>链接（Linking）：当所有的目标文件都生成以后，使用ld命令调用链接器完成最后的链接工作。</li>
</ul>
<h2 id="头文件处理🏷️"><a href="#头文件处理🏷️" class="headerlink" title="头文件处理🏷️"></a>头文件处理🏷️</h2><h3 id="什么是头文件"><a href="#什么是头文件" class="headerlink" title="什么是头文件"></a>什么是头文件</h3><p>头文件（HeadFile）是一个包含某个库外部声明函数和变量的文件，其扩展名通常为<code>.h</code>。<br>在使用头文件的时候，由「预处理器指令」<code>#include</code>负责加载，当预处理器看到<code>#include</code>标记时，就会用标记的头文件的内容替代<code>#include</code>。<br>预处理器的一项重要预处理功能是「头文件保护符」，头文件保护符依赖于预处理变量，用于防治重复包含头文件内容。预处理变量有两种状态：已定义和未定义。<br><code>#define</code>指令把一个名字设定为预处理变量，另外两个指令则负责分别检查某个指定的预处理变量变量是否已经定义：<code>#ifdef</code>当且仅当变量已经定义时为真，<code>#ifndef</code>当且仅当变量未定义时为真。一旦检查结果为真，则执行后续操作直到遇到<code>#endif</code>指令为止。<br>使用这些功能就能有效防止头文件内容被重复包含：</p>
<figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C++"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> TEST_H_</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TEST_H_</span><br><span class="hljs-comment">// 省略代码</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br></code></pre></div></td></tr></table></figure>
<p>假设上述内容是头文件<code>test.h</code>的内容，在第一次包含<code>test.h</code>文件时，<code>#ifndef</code>的检查结果为真，预处理器将顺序执行后面的操作直至遇到<code>#endif</code>为止。此时预处理变量<code>TEST_H_</code>的值变为已定义，而且该头文件的内容也会被拷贝到使用<code>#include</code>指令标记的位置。后面如果再一次包含<code>test.h</code>文件，则<code>#ifndef</code>的检查结果为假，编译器将忽略<code>#ifndef</code>到<code>#endif</code>之间的部分。</p>
<h3 id="头文件的加载方式"><a href="#头文件的加载方式" class="headerlink" title="头文件的加载方式"></a>头文件的加载方式</h3><p><code>#include</code>预处理器指令加载头文件的形式有两种：尖括号<code>&lt;&gt;</code>和双引号<code>&quot;&quot;</code>。两者的主要区别主要体现在「搜索路径」上。但都遵循相同的搜索规则，也即使用搜索到的符合要求的第一个头文件。<br>使用「尖括号」时的搜索顺序为：</p>
<ol>
<li>通过<code>gcc -I</code>指定的目录</li>
<li>通过环境变量<code>C_INCLUDE_PATH</code>指定的目录</li>
<li>最后查找系统的内定目录</li>
</ol>
<p>使用「双引号」时的搜索顺序：</p>
<ol>
<li>项目当前目录</li>
<li>通过GCC参数<code>gcc -I</code>指定的目录</li>
<li>通过环境变量<code>C_INCLUDE_PATH</code>指定的目录</li>
<li>最后查找系统的内定目录</li>
</ol>
<p>可以看到，使用双引号加载头文件时，会首先从当前目录进行搜索，若未找到，则按照使用尖括号的方式继续搜索。</p>
<h3 id="头文件的搜索目录"><a href="#头文件的搜索目录" class="headerlink" title="头文件的搜索目录"></a>头文件的搜索目录</h3><p>可以使用<code>cpp -v</code>命令来查看GCC的内定搜索目录，也即所谓的官方路径（标准的系统头文件路径）：<br><img src="https://cdn.jsdelivr.net/gh/Ap0l1o/ImageHostingService@main/img/GCC/F-1.png" srcset="/img/loading.gif" lazyload><br>这实际上同时包含了C和C++的标准头文件目录。如果想明确查看C或C++的标准头文件路径可以分别使用下图中标识的命令进行查看：<br><img src="https://cdn.jsdelivr.net/gh/Ap0l1o/ImageHostingService@main/img/GCC/F-1-1.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>注意⚠️：<br>命令中「反引号」的作用是将其所包含的命令执行结果作为命令调用。<br>「usr」并不是用户「user」的缩写，而是「Unix System Resource」的缩写。</p>
</blockquote>
<p>在编译程序时，如果我们自己的头文件没有放到官方路径下面，我们可以通过<code>gcc -I</code>来指定头文件路径，编译器在编译程序时，就会到用户指定的路径目录下去搜索该头文件。此外，还可以通过设置环境变量来添加头文件的搜索路径。在Linux环境下常用的环境变量有：</p>
<ul>
<li><code>PATH</code>：可执行程序的搜索路径</li>
<li><code>C_INCLUDE_PATH</code>：C语言头文件的搜索路径</li>
<li><code>CPLUS_INCLUDE_PATH</code>：C++头文件的搜索路径</li>
<li><code>LIBRARY_PATH</code>：库文件搜索路径</li>
</ul>
<h2 id="链接库的处理🏷️"><a href="#链接库的处理🏷️" class="headerlink" title="链接库的处理🏷️"></a>链接库的处理🏷️</h2><h3 id="什么是库文件"><a href="#什么是库文件" class="headerlink" title="什么是库文件"></a>什么是库文件</h3><p>C/C++中提供某个库通常有三种方法：</p>
<ul>
<li>头文件（<code>.h</code>）+ 源代码（<code>.c</code>和<code>.cc</code>）</li>
<li>头文件（<code>.h</code>）+ 静态库（Linux下的<code>.a</code>文件和Windows下的<code>.lib</code>文件）</li>
<li>头文件（<code>.h</code>）+ 动态库（Linux下的<code>.so</code>文件和Windows下的<code>.dll</code>文件）</li>
</ul>
<p>头文件是预处理和编译时所必须的，静态库是链接时必须的，动态库是运行时必须的。<br>程序在使用一个函数之前，应该首先声明该函数。为了便于使用，通常的做法是把同一类函数或数据结构以及常数的声明放在一个头文件中。头文件中也可以包括任何相关的类型定义和宏。在程序源代码文件中则使用预处理指令<code>#include</code>来引用相关的头文件。<br>库文件中包含一系列的程序实现。如果我们需要将某个程序的实现提供给客户使用，但又不想客户看到程序实现的源代码，那我们可以将源代码文件编译成库文件，库文件是汇编后的二进制代码，是二进制的，在库文件中看不到源代码。库文件和可执行文件的区别在于，库文件不是独立程序，它们是向其他程序提供服务的代码。使用库文件的好处不仅在于对源代码进行保密，重要的是可以减少重复编译的时间，增强程序的模块化。<br>简单来说，头文件中有函数的声明，而库文件中实现函数的定义。头文件的主要作用在于多个代码文件全局变量（函数）的重用、防止定义的冲突，对各个被调用函数给出一个描述，其本身不需要包含程序的逻辑实现代码，它只起描述性作用，用户程序只需要按照头文件中的接口声明来调用相关函数或变量，链接器会从库中寻找相应的实际定义代码。也即，库文件通过头文件向外导出接口，用户程序通过头文件查找库文件。</p>
<h3 id="静态库和动态库"><a href="#静态库和动态库" class="headerlink" title="静态库和动态库"></a>静态库和动态库</h3><p>前面已经提到，库文件就是汇编后的二进制代码，库文件本身分为两种：</p>
<ul>
<li>静态库文件（Linux下的<code>.a</code>文件和Windows下的<code>.lib</code>文件）</li>
<li>动态库文件（Linux下的<code>.so</code>文件和Windows下的<code>.dll</code>文件）</li>
</ul>
<h4 id="静态库"><a href="#静态库" class="headerlink" title="静态库"></a>静态库</h4><p>静态库文件其实就是汇编后的二进制代码（<code>.o</code>文件）的一个压缩文件（archive），里面可以有一个或多个<code>.o</code>文件。程序的运行都要经过编译和链接两个步骤。<br>假如有文件<code>header.cc</code>，可以使用命令<code>gcc -c header.cc</code>进行编译，生成<code>header.o</code>中间文件，使用命令<code>ar -r libheader.a header.o</code>可以生成<code>libheader.a</code>静态库文件。因此我们说静态库文件其实就是对<code>.o</code>中间文件进行的封装，使用<code>nm libheader.a</code>命令可以查看其中封装的中间文件以及函数符号。<br><code>header.h</code>文件内容如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C++"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> HEADER_H_</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> HEADER_H_</span><br>  <br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">print_hello</span><span class="hljs-params">()</span></span>;<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br></code></pre></div></td></tr></table></figure>
<p><code>header.cc</code>文件内容如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;header.h&quot;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">print_hello</span><span class="hljs-params">()</span> </span>&#123;<br>	std::cout&lt;&lt;<span class="hljs-string">&quot;Hello world!&quot;</span>&lt;&lt;std::endl;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>执行结果如下图所示：<br><img src="https://cdn.jsdelivr.net/gh/Ap0l1o/ImageHostingService@main/img/GCC/F-2.png" srcset="/img/loading.gif" lazyload></p>
<p>链接静态库就是链接静态库中的<code>.o</code>文件，这和直接编译多个文件再链接成可执行文件一样，不过使用静态库省略了中间的编译环节，提高了效率。<br>链接静态库：<code>g++ main.cc -I./header -L./header -lheader</code>，<code>main.cc</code>文件内容如下所示：</p>
<figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;header/header.h&quot;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-built_in">print_hello</span>();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>执行结果如下图所示：<br><img src="https://cdn.jsdelivr.net/gh/Ap0l1o/ImageHostingService@main/img/GCC/F-3.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="动态库"><a href="#动态库" class="headerlink" title="动态库"></a>动态库</h4><p>动态库的创建方式有些不同。首先还是使用gcc进行汇编处理生成二进制目标代码<code>.o</code>文件，<code>g++ -fPIC -c header.cc</code>，因为汇编后的汇编代码要去做动态库，所以这里多了一个<code>-fPIC</code>选项，该选项创建与地址无关的编译程序（PIC，Position Independent Code），是为了能够在多个应用程序间共享（用来确定库中函数的链接位置）。然后再使用gcc从二进制目标代码生成动态库，<code>++ -shared -o libheader.so header.o </code>。生成动态库的结果如下图所示：<br><img src="https://cdn.jsdelivr.net/gh/Ap0l1o/ImageHostingService@main/img/GCC/F-4.png" srcset="/img/loading.gif" lazyload></p>
<p>动态库的链接命令和静态库文件一样，不过是优先链接<code>.so</code>动态库文件，没有动态库再链接<code>.a</code>静态库文件。链接执行结果如下图所示：<br><img src="https://cdn.jsdelivr.net/gh/Ap0l1o/ImageHostingService@main/img/GCC/F-6.png" srcset="/img/loading.gif" lazyload></p>
<p>虽然静态库和动态库的链接命令一样，但是做的事情不太一样。链接静态库文件是把库里面的函数实现复制到了可执行文件里面，所以可执行文件生成以后有没有静态库文件就不重要了。而动态链接只是在可执行文件里面记录了某些函数所要使用的动态库文件，真正的链接是在运行的时候发生的，只有运行我们生成的可执行文件，到了需要使用动态库文件里面的函数的时候，那个函数才会被加载到内存中再执行。所以涉及到了操作系统寻找动态链接库的路径问题。可以使用<code>ldd</code>程序查看我们生成的「可执行文件」都用到了哪些动态库文件： <code>ldd a.out</code>，输出结果如下图所示：<br><img src="https://cdn.jsdelivr.net/gh/Ap0l1o/ImageHostingService@main/img/GCC/F-7.png" srcset="/img/loading.gif" lazyload><br>可以看到，虽然在创建「可执行文件」的时候成功链接了动态库，但「可执行文件」指示并没有找到我们的动态库<code>libheader.so</code>，「可执行文件」并不能成功运行。<br>要让系统找到动态库文件就必须设置动态库文件的路径了，如果要在动态库文件的搜寻路径里面加上动态库所在的文件路径，或者将动态库文件放到动态库的搜寻路径里面。详情见[[#运行时定位动态库文件]]。</p>
<h3 id="库文件搜索路径"><a href="#库文件搜索路径" class="headerlink" title="库文件搜索路径"></a>库文件搜索路径</h3><p>静态库链接时搜索路径的顺序：</p>
<ul>
<li><code>gcc/g++</code>命令中<code>-L</code>参数指定的路径</li>
<li>环境变量<code>LIBRARY_PATH</code>指定的静态链接库文件搜索路径</li>
<li>最后查找默认库目录<ul>
<li><code>/lib</code> 标准共享库和静态库</li>
<li><code>/usr/lib</code> 标准共享库和静态库</li>
<li><code>/usr/local/lib</code> 本地函数库</li>
</ul>
</li>
</ul>
<p>动态库链接时、==执行时==搜索路径的顺序：</p>
<ul>
<li>编译目标代码时指定的动态库搜索路径</li>
<li>环境变量<code>LD_LIBRARY_PATH</code>指定的动态库搜索路径，它指定程序动态链接库文件搜索路径</li>
<li>配置文件<code>/etc/ld.so.conf</code>中指定的动态库搜索路径</li>
<li>默认的动态库搜索路径<code>/lib</code></li>
<li>默认的动态库搜索路径<code>/usr/lib</code></li>
</ul>
<h3 id="高速缓存动态库"><a href="#高速缓存动态库" class="headerlink" title="高速缓存动态库"></a>高速缓存动态库</h3><p>Linux大多是将函数库做成动态函数库。因为内存的访问速度远远高于硬盘，所以如果将常用的动态函数库加载到内存中，当软件套件要采用动态函数库时，就不需要重新从硬盘里读取，就可以提高动态函数库的读取速度。使用<code>ldconfig</code>命令和<code>/etc/ld.so.conf</code>配置文件可以帮我们做到这一点：</p>
<ol>
<li>首先，在配置文件<code>/etc/ld.so.conf</code>中记录「需要读入高速缓存的动态函数库所在的目录」；</li>
<li>使用<code>ldconfig [-f conf] [ -C cache] [-p]</code>命令将<code>/etc/ld.so.conf</code>中标记的动态库读进高速缓存；</li>
<li><code>/etc/ld.so.cache</code>文件中会记录所有读入了高速缓存的动态库文件名称；</li>
</ol>
<h3 id="运行时定位动态库文件"><a href="#运行时定位动态库文件" class="headerlink" title="运行时定位动态库文件"></a>运行时定位动态库文件</h3><p>前面提到了可执行文件在运行时没有找到我们链接的动态库，那么可执行文件是如何定位动态库文件的呢：</p>
<ol>
<li>当系统加载可执行代码的时候，不光要知道所依赖的动态库的名称，还要知道其绝对路径。此时就需要「动态载入器」<code>ld.so</code>和 <code>ld-linux.so*</code>（Dynamic Linker/Loader），<code>ld.so</code>程序处理<code>a.out</code>二进制格式文件，<code>ld-linux.so*</code>处理更加现代的ELF二进制格式。这两个程序具有相同的行为，使用相同的支持文件和程序（<code>ldd</code>、<code>ldconfig</code>和<code>/etc/ld.so.conf</code>），都是在程序运行期间起作用。</li>
<li>动态载入器的搜索顺序如下，找到库文件后将其载入内存<ol>
<li>ELF文件的<code>DT_RPATH</code>段；</li>
<li>环境变量<code>LD_LIBRARY_PATH</code>；</li>
<li><code>/etc/ld.so.cache</code>文件列表；</li>
<li>/lib和/usr/lib目录；</li>
</ol>
</li>
</ol>
<p>在这里我们可以通过如下方式让我们的可执行文件找到我们的动态库：</p>
<ul>
<li>如果动态库安装在<code>/lib</code>或者<code>/usr/lib</code>目录下，那么动态载入器默认能够找到，不需要其他操作；</li>
<li>如果动态库安装在其他目录下，需要将该目录添加到<code>/etc/ld.so.cache</code>文件中，操作步骤如下：<ul>
<li>在<code>/etc/ld.so.conf</code>文件中加入动态库文件所在目录的路径</li>
<li>运行<code>ldconfig</code>，该命令将会把动态库文件读入高速缓存，并在<code>/etc/ld.so.cache</code>文件中记录该动态库</li>
</ul>
</li>
</ul>
<p>操作结果如下图所示：<br><img src="https://cdn.jsdelivr.net/gh/Ap0l1o/ImageHostingService@main/img/GCC/F-8.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/tianyajuanke/p/3359100.html">https://www.cnblogs.com/tianyajuanke/p/3359100.html</a></li>
<li><a target="_blank" rel="noopener" href="http://www.embeddedlinux.org.cn/html/xinshourumen/201009/02-871.html">http://www.embeddedlinux.org.cn/html/xinshourumen/201009/02-871.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/buutterfly/article/details/5594379">https://blog.csdn.net/buutterfly/article/details/5594379</a></li>
<li>gcc和g++是什么关系？ - 孙孟越的回答 - 知乎 <a target="_blank" rel="noopener" href="https://www.zhihu.com/question/20940822/answer/1942335273">https://www.zhihu.com/question/20940822/answer/1942335273</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/128099583">https://zhuanlan.zhihu.com/p/128099583</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/ahelloyou/article/details/112620353">https://blog.csdn.net/ahelloyou/article/details/112620353</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/guojun-junguo/p/10429568.html">https://www.cnblogs.com/guojun-junguo/p/10429568.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/high_high/article/details/7193264">https://blog.csdn.net/high_high/article/details/7193264</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35508344/article/details/78361749">https://blog.csdn.net/qq_35508344/article/details/78361749</a></li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/C-C/">C/C++</a>
                    
                      <a class="hover-with-bg" href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/11/14/C%E5%92%8CC++/printf%E5%92%8C%E6%A0%87%E5%87%86%E8%BE%93%E5%87%BA/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">printf和标准输出</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/11/04/%E8%AF%BB%E8%AE%BA%E6%96%87/Long-Latency%20%E9%95%BF%E5%B0%BE%E5%BB%B6%E8%BF%9F/">
                        <span class="hidden-mobile">LSM-tree KV-store 长尾延迟</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"6ea770bf22abf781c224","clientSecret":"af10c8b29047aede4963f4d93f77f6abc18ade91","repo":"blog_gitalk","owner":"ap0l1o","admin":["ap0l1o"],"language":"zh-CN","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: '14b34533ca2122971ee425171e8039f3'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>





  

  
    <!-- MathJax -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        options: {
          renderActions: {
            findScript: [10, doc => {
              document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = { node: text, delim: '', n: 0 };
                math.end = { node: text, delim: '', n: 0 };
                doc.math.push(math);
              });
            }, '', false],
            insertedScript: [200, () => {
              document.querySelectorAll('mjx-container').forEach(node => {
                let target = node.parentNode;
                if (target.nodeName.toLowerCase() === 'li') {
                  target.parentNode.classList.add('has-jax');
                }
              });
            }, '', false]
          }
        }
      };
    </script>

    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.1.4/es5/tex-svg.js" ></script>

  











<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
